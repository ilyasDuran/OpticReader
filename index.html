<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>OMR Terminali - Özelleştirilmiş Şablon Sistemi</title>
    <script async src="https://docs.opencv.org/4.5.2/opencv.js" type="text/javascript"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #1a1a1a; color: white; display: flex; flex-direction: column; align-items: center; margin: 0; padding: 20px; }
        .main-grid { display: grid; grid-template-columns: 640px 400px; gap: 20px; max-width: 1100px; }
        .view-box { background: #000; border: 3px solid #3498db; border-radius: 10px; position: relative; overflow: hidden; height: 480px; }
        video, #canvasOutput { position: absolute; width: 100%; height: 100%; object-fit: cover; }
        .results-panel { background: white; color: #333; padding: 20px; border-radius: 10px; height: 480px; overflow-y: auto; }
        
        .controls-area { width: 100%; margin-bottom: 15px; }
        label { font-size: 12px; font-weight: bold; color: #666; display: block; margin-bottom: 5px; }
        
        select.btn { background: #34495e; text-align: left; appearance: auto; color: white; margin-bottom: 10px; }
        .btn { background: #27ae60; color: white; border: none; padding: 15px; width: 100%; cursor: pointer; font-size: 16px; border-radius: 8px; font-weight: bold; transition: 0.3s; }
        .btn:hover { opacity: 0.9; transform: translateY(-1px); }
        .btn:disabled { background: #7f8c8d; cursor: not-allowed; }
        
        #warpCanvas { width: 100%; border: 1px solid #ccc; margin-top: 10px; display: none; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { border-bottom: 1px solid #ddd; padding: 8px; text-align: center; font-size: 14px; }
        .highlight { background: #e67e22; color: white; padding: 2px 6px; border-radius: 4px; }
        #log { color: #aaa; font-size: 13px; margin-bottom: 20px; height: 20px; }
    </style>
</head>
<body>

    <h2 style="margin-bottom: 5px;">Hassas Optik Okuma Terminali</h2>
    <div id="log">Sistem hazırlanıyor...</div>

    <div class="main-grid">
        <div class="view-box">
            <video id="videoInput" autoplay playsinline></video>
            <canvas id="canvasOutput"></canvas>
        </div>

        <div class="results-panel">
            <div class="controls-area">
                <label>Sınav Şablonu Seçin:</label>
                <select id="templateSelect" class="btn">
                    <option value="">Yükleniyor...</option>
                </select>
                <button class="btn" id="scanBtn" disabled>FORMU TARA VE OKU</button>
            </div>

            <div id="status" style="font-weight: bold; color: #d35400; margin-bottom: 10px;">Lütfen şablon seçin</div>
            <canvas id="warpCanvas"></canvas>
            
            <table id="resultsTable">
                <thead><tr><th>Soru</th><th>Cevap</th><th>Doluluk</th></tr></thead>
                <tbody id="resultsBody"></tbody>
            </table>
        </div>
    </div>

    <script>
        // --- ŞABLON LİSTESİ ---
        // Buraya istediğiniz kadar dosya ekleyebilirsiniz.
        const TEMPLATE_FILES = [
            { fileName: "optik_20q_4o.json", displayName: "20 Soruluk Deneme Sınavı" },
            { fileName: "optik_quiz_10.json", displayName: "10 Soruluk Quiz" },
            { fileName: "optik_final_exam.json", displayName: "Dönem Sonu Finali" }
        ];
        // ----------------------

        let coordinateMap = null;
        const video = document.getElementById('videoInput');
        const templateSelect = document.getElementById('templateSelect');
        const scanBtn = document.getElementById('scanBtn');
        const logBox = document.getElementById('log');

        // 1. Şablonları Listele
        function listTemplates() {
            templateSelect.innerHTML = '<option value="">-- Şablon Seçiniz --</option>';
            TEMPLATE_FILES.forEach(item => {
                const option = document.createElement('option');
                option.value = item.fileName;
                option.innerText = item.displayName;
                templateSelect.appendChild(option);
            });
            logBox.innerText = "Şablon listesi hazır.";
        }

        // 2. Seçilen Şablonu Yükle
        templateSelect.onchange = async () => {
            const fileName = templateSelect.value;
            if (!fileName) {
                scanBtn.disabled = true;
                document.getElementById('status').innerText = "Lütfen şablon seçin";
                return;
            }

            try {
                // GitHub Pages veya yerel sunucu üzerinden dosyayı çeker
                const response = await fetch(`./${fileName}`);
                if(!response.ok) throw new Error("Dosya bulunamadı");
                coordinateMap = await response.json();
                scanBtn.disabled = false;
                logBox.innerText = `Yüklendi: ${fileName}`;
                document.getElementById('status').innerText = "Hazır, formu kameraya gösterin.";
            } catch (err) {
                logBox.innerText = "Hata: JSON dosyası okunamadı!";
                scanBtn.disabled = true;
            }
        };

        // 3. Kamera Başlatma
        navigator.mediaDevices.getUserMedia({ video: { width: 1280, height: 720, facingMode: 'environment' } })
            .then(stream => { video.srcObject = stream; });

        window.onOpenCvReady = () => {
            logBox.innerText = "OpenCV Hazır.";
            listTemplates();
        };

        // 4. Nokta Sıralama (Perspektif Düzeltme için)
        function orderPoints(pts) {
            let rect = new Array(4);
            let sums = pts.map(p => p[0] + p[1]);
            rect[0] = pts[sums.indexOf(Math.min(...sums))];
            rect[2] = pts[sums.indexOf(Math.max(...sums))];
            let diffs = pts.map(p => p[1] - p[0]);
            rect[1] = pts[diffs.indexOf(Math.min(...diffs))];
            rect[3] = pts[diffs.indexOf(Math.max(...diffs))];
            return rect;
        }

        // 5. Ana Tarama İşlemi
        scanBtn.onclick = () => {
            if (!cv || !coordinateMap) return;

            let src = new cv.Mat(video.videoHeight, video.videoWidth, cv.CV_8UC4);
            let cap = new cv.VideoCapture(video);
            cap.read(src);

            let gray = new cv.Mat();
            cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY);
            let thresh = new cv.Mat();
            cv.threshold(gray, thresh, 120, 255, cv.THRESH_BINARY_INV);

            let contours = new cv.MatVector();
            let hierarchy = new cv.Mat();
            cv.findContours(thresh, contours, hierarchy, cv.RETR_EXTERNAL, cv.CHAIN_APPROX_SIMPLE);

            let markerCoords = [];
            for (let i = 0; i < contours.size(); ++i) {
                let cnt = contours.get(i);
                let rect = cv.boundingRect(cnt);
                if (rect.width > 25 && rect.width < 100 && Math.abs(1 - rect.width/rect.height) < 0.2) {
                    markerCoords.push([rect.x + rect.width/2, rect.y + rect.height/2]);
                }
            }

            if (markerCoords.length >= 4) {
                let ordered = orderPoints(markerCoords.slice(0,4));
                processWarp(src, ordered);
                document.getElementById('status').innerText = "Tarama Tamamlandı!";
            } else {
                document.getElementById('status').innerText = `Hata: 4 köşe bulunamadı! (${markerCoords.length}/4)`;
            }

            src.delete(); gray.delete(); thresh.delete(); contours.delete(); hierarchy.delete();
        };

        function processWarp(src, points) {
            const dstW = coordinateMap.config.width;
            const dstH = coordinateMap.config.height;

            let srcPts = cv.matFromArray(4, 1, cv.CV_32FC2, [].concat(...points));
            let dstPts = cv.matFromArray(4, 1, cv.CV_32FC2, [0, 0, dstW, 0, dstW, dstH, 0, dstH]);

            let M = cv.getPerspectiveTransform(srcPts, dstPts);
            let warped = new cv.Mat();
            cv.warpPerspective(src, warped, M, new cv.Size(dstW, dstH));

            analyzeAnswers(warped);

            cv.imshow('warpCanvas', warped);
            document.getElementById('warpCanvas').style.display = "block";

            warped.delete(); srcPts.delete(); dstPts.delete(); M.delete();
        }

        function analyzeAnswers(warped) {
            let grayWarped = new cv.Mat();
            cv.cvtColor(warped, grayWarped, cv.COLOR_RGBA2GRAY);
            // Uyarlanabilir eşikleme (Işık değişimlerine karşı daha dirençli)
            cv.threshold(grayWarped, grayWarped, 150, 255, cv.THRESH_BINARY_INV);

            const resultsBody = document.getElementById('resultsBody');
            resultsBody.innerHTML = "";

            // JSON içindeki ilk formu tara
            coordinateMap.forms[0].questions.forEach(q => {
                let bestOpt = "";
                let maxFill = 0;

                Object.keys(q.coords).forEach(opt => {
                    let c = q.coords[opt];
                    let r = 22; // Okuma yarıçapı
                    let roi = grayWarped.roi(new cv.Rect(c.x - r, c.y - r, r*2, r*2));
                    let fillPercent = (cv.countNonZero(roi) / (roi.rows * roi.cols)) * 100;
                    
                    if (fillPercent > maxFill && fillPercent > 18) { // %18 eşik değeri
                        maxFill = fillPercent;
                        bestOpt = opt;
                    }
                    roi.delete();
                });

                resultsBody.innerHTML += `<tr><td>${q.q}</td><td><span class="${bestOpt?'highlight':''}">${bestOpt || '-'}</span></td><td>%${Math.round(maxFill)}</td></tr>`;
            });
            grayWarped.delete();
        }
    </script>
    <script async src="https://docs.opencv.org/4.5.2/opencv.js" onload="onOpenCvReady();"></script>
</body>
</html>
