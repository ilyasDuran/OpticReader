<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Optik Form TarayÄ±cÄ±sÄ±</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#2c3e50">

    <script async src="https://docs.opencv.org/4.5.2/opencv.js" onload="onOpenCvReady();"></script>

    <style>
        :root {
            --primary: #2c3e50;
            --accent: #27ae60; 
            --bg: #eef2f3;
            --card-bg: #ffffff;
            --text: #2c3e50;
            --input-bg: #f1f3f5;
            --safe-bottom: env(safe-area-inset-bottom, 20px);
        }

        [data-theme="dark"] {
            --primary: #ecf0f1;
            --bg: #1a1a1a;
            --card-bg: #2d2d2d;
            --text: #f5f5f5;
            --input-bg: #3d3d3d;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: var(--bg); margin: 0;
            display: flex; justify-content: center; align-items: center;
            min-height: 100dvh; color: var(--text);
            transition: background 0.3s; overflow: hidden;
        }

        .container {
            background: var(--card-bg); width: 100%; max-width: 420px;
            height: 100dvh; display: flex; flex-direction: column;
            box-shadow: 0 20px 50px rgba(0,0,0,0.3); overflow: hidden; position: relative;
        }

        @media (min-width: 481px) { .container { height: 850px; border-radius: 30px; margin: 20px; } }

        /* Navigation */
        .header {
            padding: 15px; padding-top: env(safe-area-inset-top, 15px);
            display: flex; justify-content: space-around; align-items: center;
            border-bottom: 1px solid rgba(0,0,0,0.1); z-index: 10;
        }
        .tab-btn { 
            background: none; border: none; cursor: pointer; font-size: 0.75rem; 
            font-weight: 800; color: var(--text); opacity: 0.4; transition: 0.3s;
            padding: 10px; text-transform: uppercase; letter-spacing: 1px;
        }
        .tab-btn.active { opacity: 1; color: var(--accent); border-bottom: 2px solid var(--accent); }

        /* Mode Strip */
        .mode-strip {
            display: flex; justify-content: space-between; align-items: center;
            padding: 15px 25px; background: rgba(0,0,0,0.03);
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }
        .mode-label-area { display: flex; align-items: center; gap: 12px; }
        #mode-emoji { 
            font-size: 1.3rem; transition: transform 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            display: inline-block; cursor: pointer;
        }
        .emoji-spin { transform: rotate(360deg) scale(1.2); }
        .mode-text { font-size: 0.75rem; font-weight: 800; opacity: 0.8; }

        /* Switch */
        .switch { position: relative; display: inline-block; width: 44px; height: 22px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider-switch { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider-switch:before { position: absolute; content: ""; height: 16px; width: 16px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider-switch { background-color: var(--accent); }
        input:checked + .slider-switch:before { transform: translateX(22px); }

        /* Viewport */
        .tab-viewport { flex: 1; display: flex; transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1); width: 300%; }
        .tab-content { width: 33.333%; height: 100%; overflow-y: auto; display: flex; flex-direction: column; }

        /* Setup */
        .setup-section { padding: 25px; }
        .setting-item { margin-bottom: 25px; }
        .setting-item label { display: block; font-size: 0.7rem; margin-bottom: 10px; font-weight: bold; opacity: 0.6; text-transform: uppercase; }
        .setting-item select { 
            width: 100%; padding: 15px; border-radius: 12px; border: 1px solid rgba(0,0,0,0.05); 
            background: var(--input-bg); color: var(--text); font-size: 1rem; outline: none; font-weight: 600;
        }

        /* Camera & Results */
        #tab2 { background: #000; position: relative; }
        video { width: 100%; height: 100%; object-fit: cover; }
        .scan-line {
            position: absolute; top: 0; left: 0; width: 100%; height: 2px;
            background: var(--accent); box-shadow: 0 0 15px var(--accent);
            animation: scanAnim 3s infinite linear; display: none;
        }
        @keyframes scanAnim { 0% { top: 20%; } 50% { top: 70%; } 100% { top: 20%; } }

        /* Results */
        .result-header { background: var(--input-bg); margin: 15px; padding: 20px; border-radius: 20px; text-align: center; }

        /* Bottom Controls */
        .controls-panel { 
            background: var(--card-bg); padding: 20px; 
            padding-bottom: calc(var(--safe-bottom) + 10px); 
            border-top: 1px solid rgba(0,0,0,0.1); z-index: 100;
        }
        .status-box { text-align: center; margin-bottom: 15px; font-size: 0.8rem; min-height: 40px; color: var(--accent); font-weight: 600; }
        .btn-play { 
            width: 100%; height: 60px; background: var(--accent); color: white; 
            border: none; border-radius: 15px; font-weight: bold; font-size: 1.1rem; cursor: pointer;
        }
        .btn-play:disabled { opacity: 0.3; }
    </style>
</head>
<body data-theme="light">

<div class="container">
    <div class="header">
        <button class="tab-btn active" id="btnT1" onclick="switchTab(0)">AYARLAR</button>
        <button class="tab-btn" id="btnT2" onclick="switchTab(1)">TARAMA</button>
        <button class="tab-btn" id="btnT3" onclick="switchTab(2)">SONUÃ‡LAR</button>
    </div>

    <div class="tab-viewport" id="viewport">
        <div class="tab-content" id="tab1">
            <div class="mode-strip">
                <div class="mode-label-area">
                    <span id="mode-emoji">ðŸŒ™</span>
                    <span class="mode-text" id="mode-text">GECE MODU</span>
                </div>
                <label class="switch">
                    <input type="checkbox" id="themeSwitch" onclick="toggleTheme()">
                    <span class="slider-switch"></span>
                </label>
            </div>
            <div class="setup-section">
                <div class="setting-item">
                    <label>OPTÄ°K FORM ÅžABLONU</label>
                    <select id="templateSelect" onchange="selectTemplate(this.value)">
                        <option value="">SeÃ§iniz...</option>
                        <option value="optik_20q_4o.json">20 Soru -- 4 ÅžÄ±k Optik Formu</option>
                    </select>
                </div>
                <div class="setting-item">
                    <label>CEVAP ANAHTARI</label>
                    <select id="keySelect" onchange="loadKey(this.value)">
                        <option value="">SeÃ§iniz...</option>
                        <option value="deneme1.js">Matematik SÄ±navÄ± 1</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="tab-content" id="tab2">
            <video id="videoInput" autoplay playsinline muted></video>
            <div class="scan-line" id="scanLine"></div>
        </div>

        <div class="tab-content" id="tab3">
            <div class="result-header">
                <div id="scoreDisplay" style="font-size: 2.5rem; font-weight: 900; color: var(--accent);">0.00</div>
                <div style="font-size: 0.7rem; font-weight: 800; opacity: 0.6;">TOPLAM NET</div>
            </div>
            <div style="padding: 15px;">
                <canvas id="warpCanvas" style="width: 100%; border-radius: 15px; display:none;"></canvas>
            </div>
        </div>
    </div>

    <div class="controls-panel">
        <div id="status" class="status-box">OpenCV Bekleniyor...</div>
        <button class="btn-play" id="mainActionBtn" disabled onclick="handleAction()">BAÅžLAT</button>
    </div>
</div>

<script>
    let currentStep = 0, coordinateMap = null, keyLoaded = false;
    let wakeLock = null;

    function onOpenCvReady() { document.getElementById('status').innerText = "HazÄ±r. LÃ¼tfen seÃ§imleri tamamlayÄ±n."; }

    async function toggleTheme() {
        const body = document.body;
        const emoji = document.getElementById('mode-emoji');
        const isDark = body.getAttribute('data-theme') === 'dark';
        const nextTheme = isDark ? 'light' : 'dark';
        
        body.setAttribute('data-theme', nextTheme);
        localStorage.setItem('omr_theme', nextTheme);
        
        emoji.classList.add('emoji-spin');
        updateThemeUI(nextTheme);
        setTimeout(() => emoji.classList.remove('emoji-spin'), 500);
    }

    function updateThemeUI(theme) {
        const emoji = document.getElementById('mode-emoji');
        const modeText = document.getElementById('mode-text');
        const checkbox = document.getElementById('themeSwitch');
        
        if (theme === 'dark') {
            emoji.innerText = "â˜€ï¸"; modeText.innerText = "GÃœNDÃœZ MODU"; checkbox.checked = true;
        } else {
            emoji.innerText = "ðŸŒ™"; modeText.innerText = "GECE MODU"; checkbox.checked = false;
        }
    }

    async function switchTab(idx) {
        currentStep = idx;
        document.getElementById('viewport').style.transform = `translateX(-${idx * 33.333}%)`;
        document.querySelectorAll('.tab-btn').forEach((b, i) => b.classList.toggle('active', i === idx));
        
        const scanLine = document.getElementById('scanLine');
        if(idx === 1) {
            scanLine.style.display = "block";
            document.getElementById('mainActionBtn').innerText = "ÅžÄ°MDÄ° TARA";
            startCamera();
            if ('wakeLock' in navigator) wakeLock = await navigator.wakeLock.request('screen');
        } else {
            scanLine.style.display = "none";
            document.getElementById('mainActionBtn').innerText = idx === 0 ? "KAMERAYI AÃ‡" : "YENÄ° TARAMA";
            if (wakeLock) { wakeLock.release(); wakeLock = null; }
        }
    }

    function selectTemplate(val) { if(val) { coordinateMap = { active: true }; checkReady(); } }
    function loadKey(val) { if(val) { keyLoaded = true; checkReady(); } }
    function checkReady() { if(coordinateMap && keyLoaded) { document.getElementById('mainActionBtn').disabled = false; document.getElementById('status').innerText = "HazÄ±r!"; } }

    function handleAction() {
        if(currentStep === 0) switchTab(1);
        else if(currentStep === 1) { 
            document.getElementById('status').innerText = "Analiz Ediliyor...";
            setTimeout(() => switchTab(2), 1000); 
        }
        else switchTab(0);
    }

    function startCamera() {
        const v = document.getElementById('videoInput');
        navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment', width: 1280 } }).then(s => v.srcObject = s);
    }

    // BaÅŸlat
    const savedTheme = localStorage.getItem('omr_theme') || 'light';
    document.body.setAttribute('data-theme', savedTheme);
    updateThemeUI(savedTheme);
</script>
</body>
</html>
